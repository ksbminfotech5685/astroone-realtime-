<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AstroOne Realtime (WebSocket Bridge)</title>

<style>
  body {
    font-family: "Poppins", sans-serif;
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
  }
  .card {
    background: #fff;
    width: 420px;
    border-radius: 18px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    padding: 25px 30px;
    text-align: center;
    animation: fadeIn .6s ease;
  }
  @keyframes fadeIn {
    from {opacity: 0; transform: translateY(20px);}
    to {opacity: 1; transform: translateY(0);}
  }
  input, select {
    width: 100%;
    padding: 12px;
    margin: 8px 0;
    border-radius: 10px;
    border: 1px solid #ddd;
    font-size: 15px;
    outline: none;
    transition: .2s;
  }
  input:focus, select:focus {
    border-color: #6a11cb;
    box-shadow: 0 0 0 2px #6a11cb33;
  }
  button {
    width: 100%;
    padding: 14px;
    margin-top: 10px;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    font-size: 16px;
    cursor: pointer;
    transition: .2s;
  }
  #connect { background: #6a11cb; color: #fff; }
  #connect:hover { background: #5a0fba; }
  #disconnect { background: #e74c3c; color: #fff; display: none; }
  #disconnect:hover { background: #c0392b; }
  #status { margin-top: 12px; font-size: 14px; color: #333; min-height: 20px; }
  .footer { margin-top: 14px; font-size: 12px; color: #888; }
</style>
</head>

<body>
  <div class="card">
    <h2>üîÆ AstroOne Live (WebSocket Realtime)</h2>

    <input id="name" placeholder="‡§™‡•Ç‡§∞‡§æ ‡§®‡§æ‡§Æ">
    <input id="dob" type="date">
    <input id="tob" type="time">
    <input id="pob" placeholder="‡§ú‡§®‡•ç‡§Æ ‡§∏‡•ç‡§•‡§æ‡§® (‡§∂‡§π‡§∞)">
    <select id="gender">
      <option value="">‡§≤‡§ø‡§Ç‡§ó ‡§ö‡•Å‡§®‡•á</option>
      <option value="male">‡§™‡•Å‡§∞‡•Å‡§∑</option>
      <option value="female">‡§Æ‡§π‡§ø‡§≤‡§æ</option>
      <option value="other">‡§Ö‡§®‡•ç‡§Ø</option>
    </select>

    <select id="voice">
      <option value="verse">Verse</option>
      <option value="alloy">Alloy</option>
      <option value="ash">Ash</option>
      <option value="ballad">Ballad</option>
      <option value="coral">Coral</option>
      <option value="echo">Echo</option>
      <option value="sage">Sage</option>
      <option value="shimmer">Shimmer</option>
      <option value="marin">Marin</option>
      <option value="cedar">Cedar</option>
    </select>

    <button id="connect">‚ñ∂Ô∏è Start Live Call</button>
    <button id="disconnect">‚èπ End Call</button>

    <div id="status">Fill your details and click Start.</div>
    <audio id="audioPlayer" autoplay playsinline></audio>
    <div class="footer">AstroOne Realtime ¬© 2025</div>
  </div>

<script>
let ws = null;
let mediaStream = null;
let audioCtx = null;
let processor = null;
let sourceNode = null;
let isStreaming = false;
const statusEl = document.getElementById('status');
const audioPlayer = document.getElementById('audioPlayer');

function setStatus(msg){
  statusEl.innerText = msg;
  console.log(msg);
}

// Encode Float32Array ‚Üí 16-bit PCM ‚Üí base64
function floatToBase64(float32Array){
  const len = float32Array.length;
  const buffer = new ArrayBuffer(len * 2);
  const view = new DataView(buffer);
  for(let i=0;i<len;i++){
    let s = Math.max(-1, Math.min(1, float32Array[i]));
    view.setInt16(i*2, s<0 ? s*0x8000 : s*0x7FFF, true);
  }
  let binary = '';
  const bytes = new Uint8Array(buffer);
  const chunk = 0x8000;
  for(let i=0;i<bytes.length;i+=chunk){
    binary += String.fromCharCode.apply(null, bytes.subarray(i,i+chunk));
  }
  return btoa(binary);
}

// Decode base64 ‚Üí play audio chunk
function playBase64Audio(b64){
  const audioData = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
  audioCtx = audioCtx || new AudioContext();
  audioCtx.decodeAudioData(audioData.buffer, buffer => {
    const src = audioCtx.createBufferSource();
    src.buffer = buffer;
    src.connect(audioCtx.destination);
    src.start();
  });
}

async function startCall(){
  const name=document.getElementById('name').value.trim();
  const dob=document.getElementById('dob').value;
  const tob=document.getElementById('tob').value;
  const pob=document.getElementById('pob').value.trim();
  const gender=document.getElementById('gender').value;
  const voice=document.getElementById('voice').value;
  if(!name||!dob||!tob||!pob||!gender){ setStatus("‚ö†Ô∏è ‡§∏‡§≠‡•Ä ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§≠‡§∞‡•á‡§Ç‡•§"); return; }

  // Connect to your Render WebSocket server (port 8080 is proxied internally)
  const wsURL = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.hostname + ':8080';
  ws = new WebSocket(wsURL);
  setStatus("üõ∞ Connecting to AstroOne Realtime...");

  ws.onopen = async ()=>{
    setStatus("üîÆ Connected! Initializing mic...");
    ws.send(JSON.stringify({ type:'init', name, dob, tob, pob, gender, voice }));
    // Start microphone capture
    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    audioCtx = new AudioContext();
    sourceNode = audioCtx.createMediaStreamSource(mediaStream);
    processor = audioCtx.createScriptProcessor(4096, 1, 1);
    sourceNode.connect(processor);
    processor.connect(audioCtx.destination);
    processor.onaudioprocess = (e)=>{
      if(ws && ws.readyState===WebSocket.OPEN){
        const base64 = floatToBase64(e.inputBuffer.getChannelData(0));
        ws.send(JSON.stringify({ type:'media', data:base64 }));
      }
    };
    isStreaming = true;
    document.getElementById('connect').style.display='none';
    document.getElementById('disconnect').style.display='block';
    setStatus("üéô Live call started ‚Äî speak freely...");
  };

  ws.onmessage = (e)=>{
    try{
      const msg = JSON.parse(e.data);
      if(msg?.type==='output_audio_buffer.append' && msg?.audio){
        playBase64Audio(msg.audio);
      }else if(msg?.type==='output_audio_binary' && msg?.data){
        playBase64Audio(msg.data);
      }else if(msg?.type==='init_ok'){
        console.log("Init OK from server");
      }else{
        console.log("Server:", msg);
      }
    }catch(err){ console.warn("Parse error:", err); }
  };

  ws.onclose = ()=>{ setStatus("üì¥ Call ended."); stopCall(); };
  ws.onerror = (err)=>{ console.error("WS error:", err); setStatus("‚ùå Connection error."); stopCall(); };
}

function stopCall(){
  if(processor){ processor.disconnect(); processor=null; }
  if(sourceNode){ sourceNode.disconnect(); sourceNode=null; }
  if(mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; }
  if(ws){ try{ ws.send(JSON.stringify({type:'stop'})); ws.close(); }catch{} ws=null; }
  isStreaming=false;
  document.getElementById('connect').style.display='block';
  document.getElementById('disconnect').style.display='none';
  setStatus("üì¥ Call stopped.");
}

document.getElementById('connect').onclick=startCall;
document.getElementById('disconnect').onclick=stopCall;
</script>
</body>
</html>
