<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üîÆ AstroOne Live ‚Äî Sumit Aggarwal</title>
<style>
  :root{--accent:#6a11cb;--accent-dark:#4a0fa8}
  body{margin:0;height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#6a11cb,#2575fc);font-family:Inter,system-ui,Arial;color:#222}
  .card{width:480px;background:#fff;border-radius:14px;padding:22px;box-shadow:0 14px 40px rgba(0,0,0,0.15)}
  h1{margin:0 0 10px;text-align:center;font-size:20px}
  label{font-size:13px;color:#444;margin-top:8px;display:block}
  input,select,button{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid #ddd;font-size:14px;box-sizing:border-box}
  .row{display:flex;gap:10px}
  #connect{background:var(--accent);color:#fff;border:none;cursor:pointer}
  #connect:hover{background:var(--accent-dark)}
  #disconnect{background:#e74c3c;color:#fff;border:none;cursor:pointer;display:none}
  #status{margin-top:12px;color:#333;min-height:20px;text-align:center}
  .muted{font-size:12px;color:#888;text-align:center;margin-top:8px}
</style>
</head>
<body>
  <div class="card">
    <h1>üîÆ AstroOne Live ‚Äî Talk with Sumit Aggarwal</h1>

    <label>‡§™‡•Ç‡§∞‡§æ ‡§®‡§æ‡§Æ</label>
    <input id="name" placeholder="‡§™‡•Ç‡§∞‡§æ ‡§®‡§æ‡§Æ">

    <div class="row">
      <div style="flex:1">
        <label>DOB</label>
        <input id="dob" type="date">
      </div>
      <div style="flex:1">
        <label>Time</label>
        <input id="tob" type="time">
      </div>
    </div>

    <label>Place of Birth (POB)</label>
    <input id="pob" placeholder="‡§∂‡§π‡§∞, ‡§∞‡§æ‡§ú‡•ç‡§Ø ‡§Ø‡§æ ‡§¶‡•á‡§∂">

    <div class="row">
      <div style="flex:1">
        <label>Gender</label>
        <select id="gender"><option value="">Select</option><option value="male">Male</option><option value="female">Female</option></select>
      </div>
      <div style="flex:1">
        <label>Voice</label>
        <select id="voice">
          <option value="verse">Verse</option>
          <option value="alloy">Alloy</option>
          <option value="ash">Ash</option>
          <option value="ballad">Ballad</option>
          <option value="coral">Coral</option>
          <option value="echo">Echo</option>
          <option value="sage">Sage</option>
          <option value="shimmer">Shimmer</option>
          <option value="marin">Marin</option>
          <option value="cedar">Cedar</option>
        </select>
      </div>
    </div>

    <div style="margin-top:12px;display:flex;gap:10px">
      <button id="connect">‚ñ∂Ô∏è Start Live Call</button>
      <button id="disconnect">‚èπ Stop</button>
    </div>

    <div id="status">Fill details and press Start.</div>
    <div class="muted">Note: Allow microphone permissions in your browser.</div>
  </div>

<script>
// --- CONFIG ---
const SOURCE_RATE = 24000; // OpenAI Realtime PCM rate
const connectBtn = document.getElementById("connect");
const disconnectBtn = document.getElementById("disconnect");
const statusEl = document.getElementById("status");

let ws=null,audioCtx=null,workletNode=null,micStream=null,commitTimer=null;

// --- STATUS ---
function setStatus(t){statusEl.innerText=t;console.log(t);}

// --- FLOAT -> BASE64 PCM16 ---
function floatToBase64(float32){
  const len=float32.length,b=new ArrayBuffer(len*2),v=new DataView(b);
  for(let i=0;i<len;i++){
    let s=Math.max(-1,Math.min(1,float32[i]));
    v.setInt16(i*2,s<0?s*0x8000:s*0x7FFF,true);
  }
  let bin="",bytes=new Uint8Array(b),chunk=0x8000;
  for(let i=0;i<bytes.length;i+=chunk)
    bin+=String.fromCharCode.apply(null,bytes.subarray(i,i+chunk));
  return btoa(bin);
}

// --- PLAY PCM BASE64 (resample 24k -> device) ---
async function playPCMBase64(b64){
  try{
    const bytes=Uint8Array.from(atob(b64),c=>c.charCodeAt(0));
    const len=bytes.length/2;
    const f32=new Float32Array(len);
    for(let i=0;i<len;i++){
      const lo=bytes[i*2],hi=bytes[i*2+1];
      const val=(hi<<8)|lo;
      f32[i]=(val>32767?val-65536:val)/32768;
    }
    if(!audioCtx)audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    const outRate=audioCtx.sampleRate;
    if(Math.abs(outRate-SOURCE_RATE)<10){
      const buf=audioCtx.createBuffer(1,len,SOURCE_RATE);
      buf.getChannelData(0).set(f32);
      const s=audioCtx.createBufferSource();s.buffer=buf;
      s.connect(audioCtx.destination);s.start();return;
    }
    const off=new OfflineAudioContext(1,Math.ceil(len*outRate/SOURCE_RATE),outRate);
    const buf=off.createBuffer(1,len,SOURCE_RATE);
    buf.getChannelData(0).set(f32);
    const src=off.createBufferSource();src.buffer=buf;src.connect(off.destination);src.start();
    const rendered=await off.startRendering();
    const p=audioCtx.createBufferSource();p.buffer=rendered;p.connect(audioCtx.destination);p.start();
  }catch(e){console.warn("play err",e);}
}

// --- AUDIO WORKLET PROCESSOR (modern mic capture) ---
class MicProcessor extends AudioWorkletProcessor{
  process(inputs){
    if(inputs&&inputs[0]&&inputs[0][0]){
      const ch=inputs[0][0];
      const msg=floatToBase64(ch);
      this.port.postMessage(msg);
    }
    return true;
  }
}
registerProcessor("mic-processor",MicProcessor);
</script>

<script type="module">
let audioCtx,micNode;
async function startCall(){
  const name=nameEl.value.trim(),dob=dobEl.value,tob=tobEl.value,pob=pobEl.value.trim(),
        gender=genderEl.value,voice=voiceEl.value||"verse";
  if(!name||!dob||!tob||!pob||!gender){setStatus("‚ö†Ô∏è ‡§∏‡§≠‡•Ä ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§≠‡§∞‡•á‡§Ç‡•§");return;}
  const wsUrl=(location.protocol==="https:"?"wss://":"ws://")+location.host+"/ws";
  ws=new WebSocket(wsUrl);setStatus("üõ∞ Connecting...");
  ws.onopen=async()=>{
    ws.send(JSON.stringify({type:"init",name,dob,tob,pob,gender,voice}));
    await new Promise(r=>setTimeout(r,800));
    micStream=await navigator.mediaDevices.getUserMedia({audio:true});
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    await audioCtx.audioWorklet.addModule(URL.createObjectURL(new Blob([document.querySelector('script').textContent],{type:'application/javascript'})));
    micNode=new AudioWorkletNode(audioCtx,"mic-processor");
    const micSrc=audioCtx.createMediaStreamSource(micStream);
    micSrc.connect(micNode);
    micNode.port.onmessage=e=>{
      if(ws&&ws.readyState===1)ws.send(JSON.stringify({type:"media",data:e.data}));
    };
    setTimeout(()=>ws.send(JSON.stringify({type:"media_commit"})),1000);
    commitTimer=setInterval(()=>{if(ws.readyState===1)ws.send(JSON.stringify({type:"media_commit"}));},2500);
    connectBtn.style.display="none";disconnectBtn.style.display="inline-block";
    setStatus("üéô Live ‚Äî ‡§¨‡•ã‡§≤‡§ø‡§è...");
  };
  ws.onmessage=e=>{
    try{const m=JSON.parse(e.data);
      if(m?.type==="output_audio_binary"&&m?.data)playPCMBase64(m.data);
    }catch(err){console.log("parse",err);}
  };
  ws.onerror=err=>{console.log("WS err",err);stopCall();};
  ws.onclose=()=>{setStatus("üì¥ Call ended.");stopCall();};
}

function stopCall(){
  if(commitTimer)clearInterval(commitTimer);
  if(micStream)micStream.getTracks().forEach(t=>t.stop());
  if(ws){try{ws.send(JSON.stringify({type:"stop"}));ws.close();}catch{}}
  connectBtn.style.display="inline-block";disconnectBtn.style.display="none";
}

const nameEl=document.getElementById("name"),
dobEl=document.getElementById("dob"),
tobEl=document.getElementById("tob"),
pobEl=document.getElementById("pob"),
genderEl=document.getElementById("gender"),
voiceEl=document.getElementById("voice");
document.getElementById("connect").onclick=startCall;
document.getElementById("disconnect").onclick=stopCall;
</script>
</body>
</html>
