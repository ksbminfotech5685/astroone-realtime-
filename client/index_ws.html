<script>
let ws = null;
let mediaStream = null;
let audioCtx = null;
let processor = null;
let sourceNode = null;
let isStreaming = false;
const statusEl = document.getElementById('status');
const audioPlayer = document.getElementById('audioPlayer');

function setStatus(msg){ statusEl.innerText = msg; console.log(msg); }

function floatToBase64(float32Array){
  const len = float32Array.length;
  const buffer = new ArrayBuffer(len * 2);
  const view = new DataView(buffer);
  for(let i=0;i<len;i++){
    let s = Math.max(-1, Math.min(1, float32Array[i]));
    view.setInt16(i*2, s<0 ? s*0x8000 : s*0x7FFF, true);
  }
  let binary = '';
  const bytes = new Uint8Array(buffer);
  const chunk = 0x8000;
  for(let i=0;i<bytes.length;i+=chunk){
    binary += String.fromCharCode.apply(null, bytes.subarray(i,i+chunk));
  }
  return btoa(binary);
}

function playBase64Audio(b64){
  const audioData = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
  audioCtx = audioCtx || new AudioContext();
  audioCtx.decodeAudioData(audioData.buffer, buffer => {
    const src = audioCtx.createBufferSource();
    src.buffer = buffer;
    src.connect(audioCtx.destination);
    src.start();
  });
}

async function startCall(){
  const name=document.getElementById('name').value.trim();
  const dob=document.getElementById('dob').value;
  const tob=document.getElementById('tob').value;
  const pob=document.getElementById('pob').value.trim();
  const gender=document.getElementById('gender').value;
  const voice=document.getElementById('voice').value;
  if(!name||!dob||!tob||!pob||!gender){ setStatus("âš ï¸ à¤•à¥ƒà¤ªà¤¯à¤¾ à¤¸à¤­à¥€ à¤µà¤¿à¤µà¤°à¤£ à¤­à¤°à¥‡à¤‚à¥¤"); return; }

  const wsURL = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws';
  ws = new WebSocket(wsURL);
  setStatus("ðŸ›° Connecting...");

  ws.onopen = async ()=>{
    ws.send(JSON.stringify({ type:'init', name, dob, tob, pob, gender, voice }));
    setStatus("ðŸŽ™ Initializing mic...");
    mediaStream = await navigator.mediaDevices.getUserMedia({ audio:true });
    audioCtx = new AudioContext();
    sourceNode = audioCtx.createMediaStreamSource(mediaStream);
    processor = audioCtx.createScriptProcessor(4096,1,1);
    sourceNode.connect(processor);
    processor.connect(audioCtx.destination);

    processor.onaudioprocess = (e)=>{
      if(ws && ws.readyState === WebSocket.OPEN){
        const base64 = floatToBase64(e.inputBuffer.getChannelData(0));
        ws.send(JSON.stringify({ type:'media', data: base64 }));
      }
    };

    // Automatically commit every few seconds
    setInterval(()=>{
      if(ws && ws.readyState===WebSocket.OPEN)
        ws.send(JSON.stringify({ type:'media_commit' }));
    }, 4000);

    document.getElementById('connect').style.display='none';
    document.getElementById('disconnect').style.display='block';
    setStatus("âœ… Connected! Speak now...");
  };

  ws.onmessage = (e)=>{
    try{
      const msg = JSON.parse(e.data);
      if(msg?.type==='output_audio_binary' && msg?.data) playBase64Audio(msg.data);
    }catch{}
  };

  ws.onerror = ()=>setStatus("âŒ Connection error.");
  ws.onclose = ()=>stopCall();
}

function stopCall(){
  if(processor){ processor.disconnect(); processor=null; }
  if(sourceNode){ sourceNode.disconnect(); sourceNode=null; }
  if(mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; }
  if(ws){ try{ ws.send(JSON.stringify({type:'stop'})); ws.close(); }catch{} ws=null; }
  document.getElementById('connect').style.display='block';
  document.getElementById('disconnect').style.display='none';
  setStatus("ðŸ“´ Call stopped.");
}

document.getElementById('connect').onclick=startCall;
document.getElementById('disconnect').onclick=stopCall;
</script>
