<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>üîÆ AstroOne Live ‚Äî Sumit Aggarwal</title>
<style>
  body{font-family:Poppins,Arial;background:linear-gradient(135deg,#6a11cb,#2575fc);display:flex;justify-content:center;align-items:center;height:100vh;margin:0}
  .card{background:#fff;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.15);padding:25px;width:420px;text-align:center}
  h2{margin:0 0 15px}
  input,select,button{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #ddd;font-size:15px}
  #connect{background:#6a11cb;color:#fff;border:none}
  #disconnect{background:#e74c3c;color:#fff;border:none;display:none}
  #status{margin-top:10px;color:#333;font-size:14px;min-height:20px}
</style>
</head>
<body>
<div class="card">
  <h2>üîÆ Talk with Sumit Aggarwal</h2>
  <input id="name" placeholder="‡§™‡•Ç‡§∞‡§æ ‡§®‡§æ‡§Æ">
  <input id="dob" type="date">
  <input id="tob" type="time">
  <input id="pob" placeholder="‡§ú‡§®‡•ç‡§Æ ‡§∏‡•ç‡§•‡§æ‡§® (‡§∂‡§π‡§∞)">
  <select id="gender"><option value="">‡§≤‡§ø‡§Ç‡§ó ‡§ö‡•Å‡§®‡•á</option><option value="male">‡§™‡•Å‡§∞‡•Å‡§∑</option><option value="female">‡§Æ‡§π‡§ø‡§≤‡§æ</option></select>
  <select id="voice">
    <option value="verse">Verse</option>
    <option value="alloy">Alloy</option>
    <option value="ash">Ash</option>
    <option value="ballad">Ballad</option>
    <option value="coral">Coral</option>
    <option value="echo">Echo</option>
    <option value="sage">Sage</option>
    <option value="shimmer">Shimmer</option>
    <option value="marin">Marin</option>
    <option value="cedar">Cedar</option>
  </select>
  <button id="connect">‚ñ∂Ô∏è Start Live Call</button>
  <button id="disconnect">‚èπ Stop</button>
  <div id="status">Fill details and start.</div>
  <audio id="audioPlayer" autoplay playsinline></audio>
</div>

<script>
let ws=null, mediaStream=null, audioCtx=null, processor=null, src=null, timer=null;
function setStatus(t){document.getElementById("status").innerText=t;console.log(t);}
function floatToBase64(arr){const b=new ArrayBuffer(arr.length*2);const v=new DataView(b);for(let i=0;i<arr.length;i++){let s=Math.max(-1,Math.min(1,arr[i]));v.setInt16(i*2,s<0?s*0x8000:s*0x7FFF,true);}let bin='',bytes=new Uint8Array(b),chunk=0x8000;for(let i=0;i<bytes.length;i+=chunk){bin+=String.fromCharCode.apply(null,bytes.subarray(i,i+chunk));}return btoa(bin);}
function playAudio(b64){try{const bytes=Uint8Array.from(atob(b64),c=>c.charCodeAt(0));audioCtx=audioCtx||new AudioContext();audioCtx.decodeAudioData(bytes.buffer,bf=>{const s=audioCtx.createBufferSource();s.buffer=bf;s.connect(audioCtx.destination);s.start();});}catch(e){console.log(e);}}

async function startCall(){
  const name=document.getElementById('name').value.trim(),dob=document.getElementById('dob').value,tob=document.getElementById('tob').value,pob=document.getElementById('pob').value.trim(),gender=document.getElementById('gender').value,voice=document.getElementById('voice').value;
  if(!name||!dob||!tob||!pob||!gender){setStatus("‚ö†Ô∏è ‡§∏‡§≠‡•Ä ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§≠‡§∞‡•á‡§Ç‡•§");return;}
  const wsURL=(location.protocol==="https:"?"wss://":"ws://")+location.host+"/ws";
  ws=new WebSocket(wsURL);
  setStatus("üõ∞ Connecting...");
  ws.onopen=async()=>{
    setStatus("üîÆ Connected, starting mic...");
    ws.send(JSON.stringify({type:"init",name,dob,tob,pob,gender,voice}));
    await new Promise(r=>setTimeout(r,1000));
    mediaStream=await navigator.mediaDevices.getUserMedia({audio:true});
    audioCtx=new AudioContext();
    src=audioCtx.createMediaStreamSource(mediaStream);
    processor=audioCtx.createScriptProcessor(4096,1,1);
    src.connect(processor);processor.connect(audioCtx.destination);
    processor.onaudioprocess=(e)=>{if(ws&&ws.readyState===1){const b64=floatToBase64(e.inputBuffer.getChannelData(0));ws.send(JSON.stringify({type:"media",data:b64}));}};
    timer=setInterval(()=>{if(ws&&ws.readyState===1){ws.send(JSON.stringify({type:"media_commit"}));}},2500);
    document.getElementById('connect').style.display='none';
    document.getElementById('disconnect').style.display='block';
    setStatus("üéô ‡§¨‡•ã‡§≤‡§ø‡§è...");
  };
  ws.onmessage=(ev)=>{try{const m=JSON.parse(ev.data);if(m?.type==='output_audio_binary'&&m?.data)playAudio(m.data);}catch(e){}};
  ws.onerror=(e)=>{console.log("WS error",e);setStatus("‚ùå Connection error.");stopCall();};
  ws.onclose=()=>{setStatus("üì¥ Call ended");stopCall();};
}
function stopCall(){if(timer){clearInterval(timer);timer=null;}if(processor){processor.disconnect();processor=null;}if(src){src.disconnect();src=null;}if(mediaStream){mediaStream.getTracks().forEach(t=>t.stop());mediaStream=null;}if(ws){try{ws.send(JSON.stringify({type:"stop"}));ws.close();}catch{}ws=null;}document.getElementById('connect').style.display='block';document.getElementById('disconnect').style.display='none';}
document.getElementById('connect').onclick=startCall;
document.getElementById('disconnect').onclick=stopCall;
</script>
</body>
</html>
