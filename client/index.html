<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ЁЯФо AstroOne Realtime тАФ Final Stable Version 3.3</title>
<style>
body{margin:0;font-family:Poppins,sans-serif;background:linear-gradient(135deg,#6a11cb 0%,#2575fc 100%);
display:flex;justify-content:center;align-items:center;height:100vh;}
.card{background:#fff;width:400px;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.2);
padding:25px 30px;text-align:center;animation:fadeIn .6s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(30px);}to{opacity:1;transform:translateY(0);}}
input,select{width:100%;padding:12px;margin:8px 0;border-radius:10px;border:1px solid #ddd;font-size:15px;}
button{width:100%;padding:14px;margin-top:10px;border:none;border-radius:10px;font-weight:600;font-size:16px;
cursor:pointer;transition:.3s;}
#startBtn{background:#6a11cb;color:#fff;}#startBtn:hover{background:#5310b8;}
#stopBtn{background:#e74c3c;color:#fff;display:none;}#stopBtn:hover{background:#c0392b;}
.status{margin-top:14px;font-size:14px;color:#333;min-height:22px;}
.footer{margin-top:14px;color:#888;font-size:12px;}
</style>
</head>
<body>
<div class="card">
<h2>ЁЯФо AstroOne Live Talk</h2>
<input id="name" placeholder="рдкреВрд░рд╛ рдирд╛рдо">
<input id="dob" type="date">
<input id="tob" type="time">
<input id="pob" placeholder="рдЬрдиреНрдо рд╕реНрдерд╛рди (рд╢рд╣рд░)">
<select id="gender"><option value="">рд▓рд┐рдВрдЧ рдЪреБрдиреЗ</option><option value="male">рдкреБрд░реБрд╖</option><option value="female">рдорд╣рд┐рд▓рд╛</option><option value="other">рдЕрдиреНрдп</option></select>
<select id="voice"><option value="verse">Verse</option><option value="alloy">Alloy</option><option value="amber">Amber</option><option value="copper">Copper</option><option value="sage">Sage</option><option value="opal">Opal</option></select>
<button id="startBtn">тЦ╢я╕П Start Live Call</button>
<button id="stopBtn">тП╣ End Call</button>
<div class="status" id="status">рдЕрдкрдиреА рдЬрд╛рдирдХрд╛рд░реА рднрд░реЗрдВ рдФрд░ Start рджрдмрд╛рдПрдБред</div>
<audio id="remoteAudio" autoplay playsinline></audio>
<div class="footer">AstroOne Realtime ┬й 2025</div>
</div>

<script>
let pc, localStream, ephemeralKey, sessionMeta;
const remoteAudio=document.getElementById("remoteAudio"),startBtn=document.getElementById("startBtn"),
stopBtn=document.getElementById("stopBtn"),statusEl=document.getElementById("status");
const setStatus=t=>statusEl.innerText=t;

async function newSession(){
  const name=document.getElementById("name").value.trim(),dob=document.getElementById("dob").value,
  tob=document.getElementById("tob").value,pob=document.getElementById("pob").value.trim(),
  gender=document.getElementById("gender").value,voice=document.getElementById("voice").value||"verse";
  const r=await fetch("/session",{method:"POST",headers:{"Content-Type":"application/json"},
  body:JSON.stringify({name,dob,tob,pob,gender,voice})});
  const d=await r.json();
  if(!d?.session) throw new Error("Session create failed");
  sessionMeta=d.session;
  ephemeralKey=sessionMeta?.client_secret?.value||sessionMeta?.client_secret;
}

async function startCall(){
  const name=document.getElementById("name").value.trim();
  if(!name) return setStatus("тЪая╕П рд╕рднреА рд╡рд┐рд╡рд░рдг рднрд░реЗрдВред");
  setStatus("ЁЯФо Connecting...");
  startBtn.disabled=true; stopBtn.style.display="block";

  await newSession(); // create first session
  localStream=await navigator.mediaDevices.getUserMedia({audio:true});
  pc=new RTCPeerConnection();
  pc.ontrack=e=>{remoteAudio.srcObject=e.streams[0];remoteAudio.play().catch(()=>{});};
  for(const t of localStream.getTracks()) pc.addTrack(t,localStream);
  const offer=await pc.createOffer(); await pc.setLocalDescription(offer);
  const model=sessionMeta?.model||"gpt-4o-realtime-preview";
  const res=await fetch(`https://api.openai.com/v1/realtime?model=${model}`,{
    method:"POST",headers:{Authorization:`Bearer ${ephemeralKey}`,"Content-Type":"application/sdp"},body:offer.sdp});
  const ans=await res.text(); await pc.setRemoteDescription({type:"answer",sdp:ans});
  setStatus("тЬЕ Live call connected! рдмреЛрд▓рдирд╛ рд╢реБрд░реВ рдХрд░реЗрдВ...");

  // refresh token every 55s
  setInterval(async()=>{try{await newSession();console.log("ЁЯФБ Token refreshed");}catch{}},55000);
}

function stopCall(){
  if(localStream) localStream.getTracks().forEach(t=>t.stop());
  if(pc) pc.close();
  startBtn.disabled=false; stopBtn.style.display="none";
  setStatus("ЁЯУ┤ Call ended.");
}

startBtn.onclick=startCall; stopBtn.onclick=stopCall;
</script>
</body>
</html>
