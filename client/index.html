<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üîÆ AstroOne Realtime ‚Äî Live Astrology Call</title>

  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: linear-gradient(135deg, #6c63ff 0%, #42a5f5 100%);
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      background: #fff;
      width: 420px;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      padding: 30px 28px;
      text-align: center;
      transition: all .3s ease;
    }
    h1 {
      color: #4a4a4a;
      font-size: 22px;
      margin-bottom: 18px;
    }
    input, select {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border-radius: 10px;
      border: 1px solid #ddd;
      font-size: 15px;
      outline: none;
      transition: .2s;
    }
    input:focus, select:focus { border-color: #6c63ff; box-shadow: 0 0 0 2px #6c63ff33; }

    button {
      width: 100%;
      padding: 14px;
      margin-top: 10px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: .2s;
    }
    #startBtn {
      background: #6c63ff;
      color: #fff;
    }
    #startBtn:hover { background: #5a52e0; }
    #stopBtn {
      background: #e74c3c;
      color: #fff;
      display: none;
    }
    #stopBtn:hover { background: #d13f2f; }
    .status {
      margin-top: 15px;
      font-size: 14px;
      color: #555;
      min-height: 20px;
    }
    .footer {
      margin-top: 15px;
      font-size: 12px;
      color: #888;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîÆ AstroOne Live ‚Äî Talk with Sumit Aggarwal</h1>

    <input id="name" placeholder="‡§™‡•Ç‡§∞‡§æ ‡§®‡§æ‡§Æ">
    <input id="dob" type="date">
    <input id="tob" type="time">
    <input id="pob" placeholder="‡§ú‡§®‡•ç‡§Æ ‡§∏‡•ç‡§•‡§æ‡§® (‡§∂‡§π‡§∞)">
    <select id="gender">
      <option value="">‡§≤‡§ø‡§Ç‡§ó ‡§ö‡•Å‡§®‡•á</option>
      <option value="male">‡§™‡•Å‡§∞‡•Å‡§∑</option>
      <option value="female">‡§Æ‡§π‡§ø‡§≤‡§æ</option>
      <option value="other">‡§Ö‡§®‡•ç‡§Ø</option>
    </select>
    <select id="voice">
      <option value="verse">Voice: Verse (Default)</option>
      <option value="alloy">Alloy</option>
      <option value="amber">Amber</option>
      <option value="copper">Copper</option>
      <option value="sage">Sage</option>
      <option value="opal">Opal</option>
    </select>

    <button id="startBtn">‚ñ∂Ô∏è Start Live Call</button>
    <button id="stopBtn">‚èπ End Call</button>

    <div class="status" id="status">Fill your birth details and press Start.</div>

    <audio id="remoteAudio" autoplay></audio>

    <div class="footer">AstroOne Realtime ¬© 2025</div>
  </div>

  <script>
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const remoteAudio = document.getElementById('remoteAudio');
    const statusEl = document.getElementById('status');
    let pc, localStream, ephemeralKey, sessionMeta;

    function setStatus(msg){ statusEl.innerText = msg; }

    async function startCall() {
      const name = document.getElementById('name').value.trim();
      const dob = document.getElementById('dob').value;
      const tob = document.getElementById('tob').value;
      const pob = document.getElementById('pob').value.trim();
      const gender = document.getElementById('gender').value;
      const voice = document.getElementById('voice').value || 'verse';
      if(!name||!dob||!tob||!pob||!gender){ return setStatus("‚ö†Ô∏è ‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§≠‡•Ä ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§≠‡§∞‡•á‡§Ç‡•§"); }

      setStatus("üîÆ Connecting with AstroOne Realtime...");
      startBtn.disabled = true;

      const resp = await fetch('/session', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ name,dob,tob,pob,gender,voice })
      });
      const data = await resp.json();
      if(!data?.session){ setStatus("‚ùå Session creation failed."); console.log(data); return; }
      sessionMeta = data.session;
      ephemeralKey = sessionMeta?.client_secret?.value || sessionMeta?.client_secret;
      if(!ephemeralKey){ setStatus("‚ùå Invalid session key."); console.log(sessionMeta); return; }

      localStream = await navigator.mediaDevices.getUserMedia({ audio:true, video:false });
      pc = new RTCPeerConnection();
      pc.ontrack = e => { remoteAudio.srcObject = e.streams[0]; remoteAudio.play().catch(()=>{}); };
      for(const t of localStream.getTracks()) pc.addTrack(t, localStream);

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      const modelName = sessionMeta?.model || "gpt-4o-realtime-preview";
      const url = `https://api.openai.com/v1/realtime?model=${encodeURIComponent(modelName)}`;
      const res = await fetch(url, {
        method:'POST',
        headers:{'Authorization':`Bearer ${ephemeralKey}`,'Content-Type':'application/sdp'},
        body: offer.sdp
      });
      const answer = await res.text();
      await pc.setRemoteDescription({type:'answer', sdp:answer});
      setStatus("‚úÖ Live call connected! You can start speaking.");
      stopBtn.style.display="block";
    }

    function stopCall(){
      if(localStream) localStream.getTracks().forEach(t=>t.stop());
      if(pc) pc.close();
      startBtn.disabled=false; stopBtn.style.display="none";
      setStatus("üì¥ Call ended.");
    }

    startBtn.onclick=startCall;
    stopBtn.onclick=stopCall;
  </script>
</body>
</html>
